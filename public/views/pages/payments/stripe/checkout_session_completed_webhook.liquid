---
method: post
layout: null
---
{% liquid
  function valid_webhook = 'modules/payments_stripe/commands/webhooks/is_valid', webhook_path: '/payments/stripe/checkout_session_completed_webhook', context: context
  if valid_webhook
    assign requester = context.current_user
    unless requester
      assign requester = null | hash_merge: id: 'stripe_webhook_request'
    endunless

    function object = 'modules/payments_stripe/commands/checkout_session/complete', object: context.post_params, requester: requester, request_url: context.location.url
    if object.valid
      echo object
    else
      # Stripe will ping all endpoints so maybe we get another instance's ID
      # and that's why the command will not valid.
      # We should not send 500 status response in this case, because the request was valid,
      # but it was not relevant in the current instance.

      assign log_level = 'WARNING'
      if object.errors.transaction_id contains 'not exist'
        response_status 202
      else
        assign log_level = 'ERROR'
        response_status 500
      endif

      # Log the problem in the correct level.
      assign log_type = log_level | append: ': payments_stripe/checkout_session_completed_webhook object'
      log object, type: log_type

      echo object
    endif
  else
    log context, type: 'ERROR: payments_stripe/checkout_session_completed_webhook invalid webhook'
    response_status 403
    break
  endif
%}
